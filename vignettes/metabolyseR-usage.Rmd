---
title: "metabolyseR"
author: "Jasen Finch"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{metabolyseR-usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

Extracting biological information  related to experimental treatments from metabolomics data involves steps requiring data pre-treatment, assessing the extent discrimination between treatment classes and identifying explanatory features responsible for this discrimination.
The metabolyseR oackage provides a suite of methods that encompass these aspects of metabolomics data analysis.
Below shows the four analysis elements in that make up metabolyseR.

```{r,echo=FALSE,fig.width=6}
  DiagrammeR::grViz(readr::read_file('figures/metabolyseR.gv'))
```

This document will provide a tutorial on the basic usage of the package, followed by more detailed discussion of each of the analysis elements.
Lastly, there will be discussion of the tools for the visualisation of the results from these data as well as the integration of metabolyseR into wider metabolomics workflows.
This allows more bespoke analyses to be performed based on the particular metabolomics technique being used.

## Basic Usage

The example used here is a flow-infusion electrospray high resolution mass spectrometry (FIE-HRMS) data set provided by the [metaboData](https://github.com/jasenfinch/metaboData) package and spectrally binned using the [binneRlyse](https://github.com/jasenfinch/binneRlyse) package.

## Pre-Treatment

```{r,echo=FALSE,fig.width=6}
  DiagrammeR::grViz(readr::read_file('figures/preTreat.gv'))
```

### Remove Samples and Classes
```{r,echo=FALSE,results='asis'}
desc <- metabolyseR:::removeMethods(description = T)
args <- lapply(desc,function(x){return(x$arguments)})
args <- lapply(args,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
args <- lapply(args,function(x){apply(x,1,function(y){paste(y,collapse = ' - ')})})
if (T %in% (sapply(args,length) > 1)) {
  args[sapply(args,length) > 1] <- lapply(args[sapply(args,length) > 1],function(x){paste(x,collapse = '; ')})
}
args <- unlist(args)
desc <- unlist(lapply(desc,function(x){return(x$description)}))
meth <- names(metabolyseR:::removeMethods())
defaults <- lapply(metabolyseR:::removeMethods(),formals)
defaults <- lapply(defaults,function(x){x$dat <- NULL;return(x)})
defaults <- lapply(defaults,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
defaults <- lapply(defaults,function(x){apply(x,1,function(y){paste(y,collapse = ' = ')})})
if (T %in% (sapply(defaults,length) > 1)) {
  defaults[sapply(defaults,length) > 1] <- lapply(defaults[sapply(defaults,length) > 1],function(x){paste(x,collapse = '; ')})
}
defaults <- unlist(defaults)
tab <- tibble::tibble(Method = meth, Description = desc, Arguments = args, Defaults = defaults)

knitr::kable(tab)
```

### Filter Variables based on occupancy
```{r,echo=FALSE,results='asis'}
desc <- metabolyseR:::occupancyMethods(description = T)
args <- lapply(desc,function(x){return(x$arguments)})
args <- lapply(args,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
args <- lapply(args,function(x){apply(x,1,function(y){paste(y,collapse = ' - ')})})
if (T %in% (sapply(args,length) > 1)) {
  args[sapply(args,length) > 1] <- lapply(args[sapply(args,length) > 1],function(x){paste(x,collapse = '; ')})
}
args <- unlist(args)
desc <- unlist(lapply(desc,function(x){return(x$description)}))
meth <- names(metabolyseR:::occupancyMethods())
defaults <- lapply(metabolyseR:::occupancyMethods(),formals)
defaults <- lapply(defaults,function(x){x$dat <- NULL;return(x)})
defaults <- lapply(defaults,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
defaults <- lapply(defaults,function(x){apply(x,1,function(y){paste(y,collapse = ' = ')})})
if (T %in% (sapply(defaults,length) > 1)) {
  defaults[sapply(defaults,length) > 1] <- lapply(defaults[sapply(defaults,length) > 1],function(x){paste(x,collapse = '; ')})
}
defaults <- unlist(defaults)
tab <- tibble::tibble(Method = meth, Description = desc, Arguments = args, Defaults = defaults)

knitr::kable(tab)
```

### Filter Variables based on QC samples
```{r,echo=FALSE,results='asis'}
desc <- metabolyseR:::QCMethods(description = T)
args <- lapply(desc,function(x){return(x$arguments)})
args <- lapply(args,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
args <- lapply(args,function(x){apply(x,1,function(y){paste(y,collapse = ' - ')})})
if (T %in% (sapply(args,length) > 1)) {
  args[sapply(args,length) > 1] <- lapply(args[sapply(args,length) > 1],function(x){paste(x,collapse = '; ')})
}
args <- unlist(args)
desc <- unlist(lapply(desc,function(x){return(x$description)}))
meth <- names(metabolyseR:::QCMethods())
defaults <- lapply(metabolyseR:::QCMethods(),formals)
defaults <- lapply(defaults,function(x){x$dat <- NULL;return(x)})
defaults <- lapply(defaults,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
defaults <- lapply(defaults,function(x){apply(x,1,function(y){paste(y,collapse = ' = ')})})
if (T %in% (sapply(defaults,length) > 1)) {
  defaults[sapply(defaults,length) > 1] <- lapply(defaults[sapply(defaults,length) > 1],function(x){paste(x,collapse = '; ')})
}
defaults <- unlist(defaults)
tab <- tibble::tibble(Method = meth, Description = desc, Arguments = args, Defaults = defaults)

knitr::kable(tab)
```

### Impute missing data
```{r,echo=FALSE,results='asis'}
desc <- metabolyseR:::imputeMethods(description = T)
args <- lapply(desc,function(x){return(x$arguments)})
args <- lapply(args,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
args <- lapply(args,function(x){apply(x,1,function(y){paste(y,collapse = ' - ')})})
if (T %in% (sapply(args,length) > 1)) {
  args[sapply(args,length) > 1] <- lapply(args[sapply(args,length) > 1],function(x){paste(x,collapse = '; ')})
}
args <- unlist(args)
desc <- unlist(lapply(desc,function(x){return(x$description)}))
meth <- names(metabolyseR:::imputeMethods())
defaults <- lapply(metabolyseR:::imputeMethods(),formals)
defaults <- lapply(defaults,function(x){x$dat <- NULL;return(x)})
defaults <- lapply(defaults,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
defaults <- lapply(defaults,function(x){apply(x,1,function(y){paste(y,collapse = ' = ')})})
if (T %in% (sapply(defaults,length) > 1)) {
  defaults[sapply(defaults,length) > 1] <- lapply(defaults[sapply(defaults,length) > 1],function(x){paste(x,collapse = '; ')})
}
defaults <- unlist(defaults)
tab <- tibble::tibble(Method = meth, Description = desc, Arguments = args, Defaults = defaults)

knitr::kable(tab)
```

### Transform the data
```{r,echo=FALSE,results='asis'}
desc <- metabolyseR:::transformMethods(description = T)
args <- lapply(desc,function(x){return(x$arguments)})
args <- lapply(args,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
args <- lapply(args,function(x){apply(x,1,function(y){paste(y,collapse = ' - ')})})
if (T %in% (sapply(args,length) > 1)) {
  args[sapply(args,length) > 1] <- lapply(args[sapply(args,length) > 1],function(x){paste(x,collapse = '; ')})
}
args <- unlist(args)
if (T %in% sapply(args,function(x){grepl("''",x)})) {
  args[sapply(args,function(x){grepl("''",x)})] <- lapply(args[sapply(args,function(x){grepl("''",x)})],function(x){''})
}
desc <- unlist(lapply(desc,function(x){return(x$description)}))
meth <- names(metabolyseR:::transformMethods())
defaults <- lapply(metabolyseR:::transformMethods(),formals)
defaults <- lapply(defaults,function(x){x$dat <- NULL;return(x)})
if (T %in% sapply(defaults,is.null)) {
  defaults[sapply(defaults,is.null)] <- lapply(defaults[sapply(defaults,is.null)],function(x){c(`''` = '')})
}
defaults <- lapply(defaults,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
defaults <- lapply(defaults,function(x){apply(x,1,function(y){paste(y,collapse = ' = ')})})

if (T %in% sapply(defaults,function(x){grepl("''",x)})) {
  defaults[sapply(defaults,function(x){grepl("''",x)})] <- lapply(defaults[sapply(defaults,function(x){grepl("''",x)})],function(x){''})
}

if (T %in% (sapply(defaults,length) > 1)) {
  defaults[sapply(defaults,length) > 1] <- lapply(defaults[sapply(defaults,length) > 1],function(x){paste(x,collapse = '; ')})
}
defaults <- unlist(defaults)
tab <- tibble::tibble(Method = meth, Description = desc, Arguments = args, Defaults = defaults)

knitr::kable(tab)
```

## Classification

## Feature Selection
```{r,echo=FALSE,results='asis'}
desc <- metabolyseR:::fsMethods(description = T)
args <- lapply(desc,function(x){return(x$arguments)})
args <- lapply(args,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
args <- lapply(args,function(x){apply(x,1,function(y){paste(y,collapse = ' - ')})})
if (T %in% (sapply(args,length) > 1)) {
  args[sapply(args,length) > 1] <- lapply(args[sapply(args,length) > 1],function(x){paste(x,collapse = '; ')})
}
args <- unlist(args)
desc <- unlist(lapply(desc,function(x){return(x$description)}))
meth <- names(metabolyseR:::fsMethods())
defaults <- lapply(metabolyseR:::fsMethods(),formals)
defaults <- lapply(defaults,function(x){x$dat <- NULL;return(x)})
defaults <- lapply(defaults,function(x){tibble::tibble(Parameter = names(x),Value = unlist(x))})
defaults <- lapply(defaults,function(x){apply(x,1,function(y){paste(y,collapse = ' = ')})})
if (T %in% (sapply(defaults,length) > 1)) {
  defaults[sapply(defaults,length) > 1] <- lapply(defaults[sapply(defaults,length) > 1],function(x){paste(x,collapse = '; ')})
}
defaults <- unlist(defaults)
tab <- tibble::tibble(Method = meth, Description = desc, Arguments = args, Defaults = defaults)

knitr::kable(tab)
```

## Correlations

## Visualisation and Workflows
